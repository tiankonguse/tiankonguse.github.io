<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>图片识别</title>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <script src="heic2any.min.js"></script>
</head>

<body>
    <div style="position: fixed;top: 5px;left: 5px;background: white;">
        <span lan_id="bc">选择图片</span> <input type="file" id="pictureChange" />
        当前颜色: <span id="hovered-color-text">rgba(0, 0, 0, 0)</span><span id="hovered-color">【0123456】</span>
        选择颜色: <span id="selected-color-text">rgba(0, 0, 0, 0)</span><span id="selected-color">【0123456】</span>
        灰度颜色: <span id="gray-color-text">rgba(0, 0, 0, 0)</span><span id="gray-color">【0123456】</span>
        <br />
        <span id="color-similarity">
            白色相似度: <span class="white">0</span>;
            黑色相似度: <span class="black">0</span>;
            红色相似度: <span class="red">0</span>;
            橙色相似度: <span class="orange">0</span>;
            蓝色相似度: <span class="blue">0</span>;
    </div>
    </div>
    <div style="margin-top: 60px;">
        <canvas id="canvas"></canvas>
    </div>
</body>
<script type="text/javascript">
    const canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    const $canvas = $("#canvas");
    const hoveredColor = document.getElementById("hovered-color");
    const selectedColor = document.getElementById("selected-color");
    const grayColor = document.getElementById("gray-color");
    const hoveredColorText = document.getElementById("hovered-color-text");
    const selectedColorText = document.getElementById("selected-color-text");
    const grayColorText = document.getElementById("gray-color-text");
    const colorSimilarity = $("#color-similarity");


    const whiteColor = [238, 238, 238]
    const blackColor = [51, 51, 51]
    const blueColor = [68, 85, 187]
    const redColor = [187, 102, 119]
    const orangeColor = [222, 150, 100]
    const colors = { "red": redColor, "orange": orangeColor, "blue": blueColor, "black": blackColor, "white": whiteColor };

    const invert = () => {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            data[i] = 255 - data[i]; // red
            data[i + 1] = 255 - data[i + 1]; // green
            data[i + 2] = 255 - data[i + 2]; // blue
            data[i + 3] = 255;
        }
        for (let i = 0; i < data.length; i += 4) {
            for (let j = 0; j < 3; j++) {
                data[i + j] = parseInt(data[i + j] / 10) * 10;

            }
        }
        ctx.putImageData(imageData, 0, 0);
    };
    const grayscale = () => {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
            data[i] = avg; // red
            data[i + 1] = avg; // green
            data[i + 2] = avg; // blue
            data[i + 3] = 255; // 
        }
        ctx.putImageData(imageData, 0, 0);
    };
    const minFix = () => {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            data[i + 3] = 255;
        }
        // for (let i = 0; i < data.length; i += 4) {
        //     for (let j = 0; j < 3; j++) {
        //         data[i + j] = parseInt((data[i + j] + 4) / 5) * 5;
        //     }
        // }
        for (let i = 0; i < data.length; i += 4) {
            // for (let j = 0; j < 3; j++) {
            //     data[i + j] = parseInt((data[i + j] + 4) / 5) * 5;
            // }

            const selectColor = [data[i], data[i + 1], data[i + 2]];

            for (let key in colors) {
                if (Distance(selectColor, colors[key]) < 50) {
                    for (let j = 0; j < 3; j++) {
                        data[i + j] = colors[key][j];
                    }
                }
            }

        }
        ctx.putImageData(imageData, 0, 0);
    };
    function pick(event, destination, destinationText) {
        const bounding = canvas.getBoundingClientRect();
        const x = event.clientX - bounding.left;
        const y = event.clientY - bounding.top;
        const pixel = ctx.getImageData(x, y, 1, 1);
        const data = pixel.data;

        const rgba = `rgba(${data[0]}, ${data[1]}, ${data[2]}, ${data[3] / 255})`;
        destination.style.color = rgba;
        destinationText.textContent = rgba;

        const gray = parseInt((data[0] + data[1] + data[2]) / 3);
        const grayRgba = `rgba(${gray}, ${gray}, ${gray}, ${data[3] / 255})`;
        grayColor.style.color = grayRgba;
        grayColorText.textContent = grayRgba;

        const selectColor = [data[0], data[1], data[2]];
        for (let key in colors) {
            colorSimilarity.find("." + key).text(Distance(selectColor, colors[key]));
        }

        return rgba;
    }
    canvas.addEventListener("mousemove", (event) => pick(event, hoveredColor, hoveredColorText));
    canvas.addEventListener("click", (event) => pick(event, selectedColor, selectedColorText));

    function Distance(vec1, vec2) {
        let sum = 0;
        for (let i = 0; i < vec1.length; i++) {
            const d = Math.abs(vec1[i] - vec2[i]);
            sum += d * d;
        }
        return Math.sqrt(sum);
    }
    function cosineSimilarity(vec1, vec2) {
        const calcVectorSize = function (vec) {
            return Math.sqrt(vec.reduce((accum, curr) => accum + Math.pow(curr, 2), 0));
        };
        const dotProduct = vec1.map((val, i) => val * vec2[i]).reduce((accum, curr) => accum + curr, 0);
        const vec1Size = calcVectorSize(vec1);
        const vec2Size = calcVectorSize(vec2);

        return dotProduct / (vec1Size * vec2Size);
    };

    function dotp(x, y) {
        function dotp_sum(a, b) {
            return a + b;
        }
        function dotp_times(a, i) {
            return x[i] * y[i];
        }
        return x.map(dotp_times).reduce(dotp_sum, 0);
    }

    function cosineSimilarity2(A, B) {
        var similarity = dotp(A, B) / (Math.sqrt(dotp(A, A)) * Math.sqrt(dotp(B, B)));
        return similarity;
    }

    $("#pictureChange").change(function (e) {
        var blob = e.target.files[0];
        console.log("select file: ", blob);
        if (blob.type == "image/heic") {
            // https://stackoverflow.com/questions/46754688/convert-heic-to-jpg-using-php-or-js
            // https://github.com/alexcorvi/heic2any/blob/master/docs/getting-started.md
            heic2any({
                blob: blob,
                toType: "image/png",
            }).then(function (resultBlob) {
                console.log("heic trans to png: ", resultBlob);
                LoadImg(resultBlob);
            }).catch(function (x) {
                console.log("catch ", x);
            });
        } else {
            LoadImg(blob);
        }

    })

    function LoadImg(blob) {
        var fr = new FileReader();
        fr.readAsDataURL(blob);
        fr.onloadend = function (e) {
            console.log("file load finish", e);
            var base64Data = e.target.result;
            ShowImg(base64Data)
        }
    }

    function ShowImg(data) {

        var img = new Image();
        img.src = data;
        img.onload = function () {
            console.log("img load finish");
            // img.width /= 2;
            // img.height /= 2;
            $canvas.attr("width", img.width)
            $canvas.attr("height", img.height)
            ctx.drawImage(img, 0, 0, img.width, img.height);
            var imageData = ctx.getImageData(0, 0, img.width, img.height);
            console.log(imageData.data, imageData.width, imageData.height);
            minFix();
        };
    }
    function showCode(code) {
        $("#result").append("<li>" + code + "</li>")
    }
</script>

</html>